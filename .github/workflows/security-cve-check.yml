name: CVE Security Check

# Prevent accidental introduction of React Server Components vulnerabilities
# Protects against CVE-2025-55182 (React2Shell) and CVE-2025-66478 (Next.js Server Actions RCE)

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: RSC CVE Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Security Guards
        run: node scripts/security-guards.js
        continue-on-error: false

      - name: Check for Server Actions (grep fallback)
        run: |
          echo "Checking for 'use server' directive..."
          if grep -r "'use server'" src/ 2>/dev/null || grep -r '"use server"' src/ 2>/dev/null; then
            echo "::error::Server Actions detected! These are incompatible with static export and vulnerable to CVE-2025-66478"
            exit 1
          fi
          echo "✅ No Server Actions found"

      - name: Check for RSC imports (grep fallback)
        run: |
          echo "Checking for React Server Components imports..."
          if grep -r "from ['\"]react-server" src/ 2>/dev/null || grep -r "from ['\"]react-server-dom" src/ 2>/dev/null; then
            echo "::error::React Server Components imports detected! These are vulnerable to CVE-2025-55182"
            exit 1
          fi
          echo "✅ No RSC imports found"

      - name: Verify package.json versions
        run: |
          echo "Checking React version..."
          REACT_VERSION=$(node -e "console.log(require('./package.json').dependencies.react || require('./package.json').devDependencies.react)")
          if [[ "$REACT_VERSION" == ^19* ]]; then
            echo "::warning::React 19 detected - ensure no Server Components are used"
          fi
          echo "✅ React version: $REACT_VERSION"

      - name: Verify static export configuration
        run: |
          echo "Checking next.config.ts for static export..."
          if ! grep -q "output: 'export'" next.config.ts 2>/dev/null; then
            echo "::warning::Static export not explicitly configured in next.config.ts"
          else
            echo "✅ Static export mode confirmed"
          fi

      - name: Generate Security Report
        if: always()
        run: |
          echo "# CVE Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date -u)" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Results" >> security-report.md
          if [ $? -eq 0 ]; then
            echo "✅ **PASSED** - No RSC vulnerabilities detected" >> security-report.md
          else
            echo "❌ **FAILED** - Security violations detected" >> security-report.md
          fi
          echo "" >> security-report.md
          echo "## Checked Vulnerabilities" >> security-report.md
          echo "- CVE-2025-55182 (React2Shell - RCE)" >> security-report.md
          echo "- CVE-2025-66478 (Next.js Server Actions RCE)" >> security-report.md
          echo "- CVE-2025-55184 (DoS)" >> security-report.md
          echo "- CVE-2025-55183 (Source Code Exposure)" >> security-report.md

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  build-verify:
    name: Verify Build
    runs-on: ubuntu-latest
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Verify static export
        run: |
          if [ ! -d "out" ]; then
            echo "::error::Build failed - out/ directory not found"
            exit 1
          fi
          echo "✅ Static export built successfully"
          ls -lh out/
